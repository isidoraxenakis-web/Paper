from pyproj import Geod
from shapely.geometry import LineString, Point, Polygon
import numpy as np
import xarray as xr
from datetime import timedelta
import datetime as dt
import matplotlib.pyplot as plt
from netCDF4 import Dataset
import cartopy.crs as ccrs
import cartopy.feature as cfeature
import matplotlib.cm
import pandas as pd
from glob import glob
import xesmf as xe
import matplotlib as mpl
from matplotlib import gridspec
import cartopy.io.shapereader as shpreader
from cartopy.feature import ShapelyFeature
import glob


#Calculating GFED Fires

#Open INFERNO monthly fire output
output_dataset_Fires = xr.open_dataset("/nfs/a68/htmq9847/Inferno_data/Monthly_mean_burnt_area_fraction_for_HistSST_INFERNO_UKESM1_2000_2014_fract_area.nc")['monthly_mean_burnt_area_fraction'][:]

Inferno_BAFm = xr.open_dataset("/nfs/a68/htmq9847/Inferno_data/Monthly_mean_burnt_area_fraction_for_HistSST_INFERNO_UKESM1_2000_2014_fract_area.nc")
latm = Inferno_BAFm['latitude'][:]
lonm = Inferno_BAFm['longitude'][:]
timem = Inferno_BAFm['time'][:]

#Reading Anual Inferno Output
Annual_output_dataset_Fires = xr.open_dataset("/nfs/a68/htmq9847/Inferno_data/Annual_mean_burnt_area_fraction_for_HistSST_INFERNO_UKESM1_2000_2014_fract_area.nc")['annual_mean_burnt_area_fraction'][:]

Inferno_BAF = xr.open_dataset("/nfs/a68/htmq9847/Inferno_data/Annual_mean_burnt_area_fraction_for_HistSST_INFERNO_UKESM1_2000_2014_fract_area.nc")
lat = Inferno_BAF['latitude'][:]
lon = Inferno_BAF['longitude'][:]
time = Inferno_BAF['time'][:]

#Sort GFED fIles
GFED_BA_files = sorted(glob.glob('/nfs/a68/htmq9847/BAF/BA20*.nc'))
 
#Open GFED files for 2000-2014 time period
GFED_BA= xr.open_mfdataset(GFED_BA_files).sel(time=slice('2000-01-01T00:00:00.000000000','2014-12-31T00:00:00.000000000'))
 
#Read total burnt area fraction in hectares
ts_BA1 = GFED_BA['Total']

#Resumple to a yearly sum
ts_BA1_resample = (ts_BA1.resample(time = "YS").sum())

#Mean across time
BAF_mean = ts_BA1_resample.mean(dim = "time")

#Convert to meters square 
BAF_Mean_ha = BAF_mean*100

#Renaming lat and lon to match the datasets
BAF_Mean_ha  = BAF_Mean_ha.rename({"lat": "latitude"})
BAF_Mean_ha  = BAF_Mean_ha.rename({"lon": "longitude"})


#GFED Grid
Grid_GFED = xr.open_dataset("/nfs/a68/htmq9847/Grid/GFED_grid_areas_hectares.nc")["grid_area"]

#Match longitude values with GFED dataset
Grid_GFED.coords['longitude'] = (Grid_GFED.coords['longitude'] + 180) % 360 - 180

Grid_GFED = Grid_GFED.sortby(Grid_GFED.longitude)


#Regrid to GFED grid
output_grid_Fires = xr.Dataset({"latitude": (["latitude"], Grid_GFED .latitude.values),

                       "longitude": (["longitude"], Grid_GFED .longitude.values)})
    
regridder_Fires = xe.Regridder(BAF_Mean_ha, Grid_GFED, "bilinear")

output_grid_Fires = regridder_Fires(BAF_Mean_ha)


#Calculating Burnt area fraction
BAF_Fraction = (output_grid_Fires/Grid_GFED)*100

#Regrid to INFERNO grid

Inf_output_grid_Fires = xr.Dataset({"latitude": (["latitude"], output_dataset_Fires.latitude.values),

                       "longitude": (["longitude"], output_dataset_Fires.longitude.values)})
    
Inf_regridder_Fires = xe.Regridder(BAF_Fraction, output_dataset_Fires, "bilinear")

Inf_output_grid_Fires = Inf_regridder_Fires(BAF_Fraction)


#Calculation for INFERNO
#Open netCDF files of daily maximum and minimum temperature
Inferno_BAF = xr.open_dataset("/nfs/a68/htmq9847/Inferno_data/Monthly_mean_burnt_area_fraction_for_HistSST_INFERNO_UKESM1_2000_2014_fract_area.nc")

#Read in variables of BAF, latitude, longitude and time
BAF = Inferno_BAF['monthly_mean_burnt_area_fraction'][:]
lat = Inferno_BAF['latitude'][:]
lon = Inferno_BAF['longitude'][:]
time = Inferno_BAF['time'][:]

#Resample according to every year
Yearly_Fires= BAF.resample(time = "YS").sum()

#Mean across time and multiply by 100 to convert to a percentage
Inf_fires = (Yearly_Fires.mean(dim = "time"))*100

Fires_Diff = Inf_fires - Inf_output_grid_Fires

#Apply GFED mask
GFED_mask = xr.open_dataset("/nfs/a68/htmq9847/mask/GFED_basis_regions.nc")['GFED_basis_regions'][:]

output_grid_Fires_GFED = xr.Dataset({"latitude": (["latitude"], output_dataset_Fires.latitude.values),

                       "longitude": (["longitude"], output_dataset_Fires.longitude.values)})
    
regridder_Fires_GFED = xe.Regridder(GFED_mask, output_grid_Fires_GFED, "bilinear")
output_grid_Fires_GFED = regridder_Fires_GFED(GFED_mask)

Fires_landonly_GFED = Fires_Diff.where((output_grid_Fires_GFED >0) & (output_grid_Fires_GFED < 15))

# Initiate new Figure 
fig= plt.figure(figsize=(10, 7))

gs = gridspec.GridSpec(1, 1)

index=0

# Initiate new axes 
ax = fig.add_subplot(gs[0], projection=ccrs.Robinson(central_longitude = 0))

#Style of axes
crs = ccrs.Robinson(central_longitude = 0)

# Add coastlines
ax.coastlines()

#Add gridlines
gl = ax.gridlines(draw_labels = True, linestyle='--')
gl.xlabel_style = {'size': 12}   # Longitude labels
gl.ylabel_style = {'size': 12}   # Latitude labels
gl.left_labels = False
#gl.top_labels = False

#Add boarders and land
ax.add_feature(cfeature.BORDERS, edgecolor='black', facecolor='None', alpha=0.5)
ax.add_feature(cfeature.LAND,  edgecolor='black', facecolor='None', alpha=0.5)

cmap = plt.cm.get_cmap("RdBu_r").copy()

#Plot square meters of fire for each grid cell
im = Fires_landonly_GFED.plot.pcolormesh(levels = [-100, -50, -20, -10, -5, -2, -1, -0.5, -0.2, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100],  cmap = cmap, add_colorbar=False, add_labels=False, transform = ccrs.PlateCarree())

#Add colourbar
ax_pos = ax.get_position()
cax = fig.add_axes([ax_pos.x0, 0.1, ax_pos.width, 0.03])
cbar = plt.colorbar(im, cax=cax, orientation='horizontal', extend = "neither")
cbar.ax.tick_params(labelsize= 15) 
