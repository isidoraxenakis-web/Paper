from pyproj import Geod
from shapely.geometry import LineString, Point, Polygon
import numpy as np
import xarray as xr
from datetime import timedelta
import datetime as dt
import matplotlib.pyplot as plt
from netCDF4 import Dataset
import cartopy.crs as ccrs
import cartopy.feature as cfeature
import matplotlib.cm
import pandas as pd
from glob import glob
import xesmf as xe
import matplotlib as mpl
from matplotlib import gridspec
import cartopy.io.shapereader as shpreader
from cartopy.feature import ShapelyFeature
import glob


#Calculation of Fires

#Open netCDF files of daily maximum and minimum temperature
Inferno_BAF = xr.open_dataset("/nfs/a68/htmq9847/Inferno_data/Monthly_mean_burnt_area_fraction_for_HistSST_INFERNO_UKESM1_2000_2014_fract_area.nc")

#Read in variables of BAF, latitude, longitude and time
BAF = Inferno_BAF['monthly_mean_burnt_area_fraction'][:]
lat = Inferno_BAF['latitude'][:]
lon = Inferno_BAF['longitude'][:]
time = Inferno_BAF['time'][:]

#Resample according to every year
Yearly_Fires= BAF.resample(time = "YS").sum()*100


#Calculation of Droughts

#Open netCDF files of daily soil mosture
Input_SM_mean = xr.open_mfdataset("/nfs/a68/htmq9847/SM_mean/*.nc")['swvl1'][:]

#Read in variables of soil moisture (Volumetric soil water layer), latitude, longitude and time
ilat = Input_SM_mean['latitude'][:]
ilon = Input_SM_mean['longitude'][:]
itime = Input_SM_mean['valid_time'][:]

#Open netCDF files of daily soil mosture
Output_SM_mean = xr.open_dataset("/nfs/a68/lec1stt/Isidora_data/Daily_mean_Met_and_soil_moisture_variables_for_HistSST_INFERNO_UKESM1_2000_2014.nc")['moisture_content_of_soil_layer'][:]

#Read in variables of soil moisture (Volumetric soil water layer), latitude, longitude and time
olat = Output_SM_mean['latitude'][:]
olon = Output_SM_mean['longitude'][:]
otime = Output_SM_mean['time'][:]

#Selecting all of the soil moisture values of the time frame
sm = Input_SM_mean.sel(valid_time = ((Input_SM_mean.valid_time.dt.day >= 1) & (Input_SM_mean.valid_time.dt.day <= 5114)))

#Calculating soil moisture across a 30-day moving window mean
thirtyday_sm = sm.rolling(valid_time = 30, center = True).mean()

#Calculate the 80th percentile of the soil moisture 9-day moving window 
Percentile_sm = thirtyday_sm.quantile(0.8, dim = 'valid_time')

#Calculate where the data soil moisture is less than the 80th Percentile
sm_function = sm.where((sm < Percentile_sm))

#Fill nan values with 0
sm1 = sm_function.fillna(0)

#Replace Soil moisture drought values with 1 
sm2 = sm1.where((sm1 == 0.0), 1)

#Calculate the difference between each successive drought soil moisture value
diff = sm2.diff(dim='valid_time', n = 1)

#Where drought event starts the difference is 1 (transition from 0 to 1) 
drought_starts = diff.where(diff == 1)


#Regridding

#For Soil Moisture 
output_grid_SM = xr.Dataset({"latitude": (["latitude"], Output_SM_mean.latitude.values),

                       "longitude": (["longitude"], Output_SM_mean.longitude.values)})

regridder_SM = xe.Regridder(drought_starts, output_grid_SM, "bilinear")

output_grid_SM = regridder_SM(drought_starts)


#Creating new time frame
times = pd.date_range("2000-01-01", "2014-12-31", freq="Y")

#Transforming to xarrat dataset
time_da = xr.DataArray(times, dims="time", name="time")

#Defining valid time
valid_time = Output_SM_mean['time'][:]

#Creating Drought xarray
Droughts_xarray = xr.DataArray(output_grid_SM, dims=('valid_time', 'latitude', 'longitude'))

#Resample the dataset to a yearly sum
Yearly_Droughts = Droughts_xarray.resample(valid_time = "YS").sum()

#Rename valid time to time
Yearly_Droughts_renamed = Yearly_Droughts.rename({"valid_time": "time"})


New_Yearly_Droughts_renamed_arr = Yearly_Droughts_renamed.compute()


#Convert time from object to datetime64[ns] type
Yearly_Fires["time"] = Yearly_Fires["time"].astype("datetime64[ns]")

#Differencing to remove persisting values (autocorrelation)
New_Drought_arr_diff = New_Yearly_Droughts_renamed_arr.diff(dim = "time")


New_Fires_arr_diff = Yearly_Fires.diff(dim = "time")


Inf_Fires_Drought_corr = xr.corr(New_Yearly_Droughts_renamed_arr, Yearly_Fires, dim = ("time"))


from scipy.stats import t 
res = np.sqrt(15- 2)

res1 = np.sqrt(1 - (Inf_Fires_Drought_corr**2))

t_vals =  (res / res1) * (Inf_Fires_Drought_corr)

t_vals = t_vals.fillna(0)
p_vals = 2 * t.sf(np.abs(t_vals), df =13)

print(p_vals.min())


Inf_Fires_Drought_corr_sign = Inf_Fires_Drought_corr.where(p_vals < 0.05)


#Application of GFED mask
GFED_mask = xr.open_dataset("/nfs/a68/htmq9847/mask/GFED_basis_regions.nc")['GFED_basis_regions'][:]

#Regrid GFED mask
output_grid_Heatwave_GFED = xr.Dataset({"latitude": (["latitude"], Inferno_BAF.latitude.values),

                       "longitude": (["longitude"], Inferno_BAF.longitude.values)})
    
regridder_Heatwave_GFED = xe.Regridder(GFED_mask, output_grid_Heatwave_GFED, "bilinear")

output_grid_Heatwave_GFED = regridder_Heatwave_GFED(GFED_mask)



Inf_Fires_Drought_corr_sign_GFED = Inf_Fires_Drought_corr_sign.where((output_grid_Heatwave_GFED >0) & (output_grid_Heatwave_GFED < 15))

Inf_Fires_Drought_corr_GFED = Inf_Fires_Drought_corr.where((output_grid_Heatwave_GFED >0) & (output_grid_Heatwave_GFED < 15))


# Initiate new Figure 
fig= plt.figure(figsize=(10, 7))

gs = gridspec.GridSpec(1, 1)

index=0

# Initiate new axes 
ax = fig.add_subplot(gs[0], projection=ccrs.Robinson(central_longitude = 0))

#Style of axes
crs = ccrs.Robinson(central_longitude = 0)

# Add coastlines
ax.coastlines()

#Add gridlines
gl = ax.gridlines(draw_labels = True, linestyle='--')

# Adjust font sizes
gl.xlabel_style = {'size': 15}   # Longitude labels
gl.ylabel_style = {'size': 15}   # Latitude labals
gl.right_labels = False
gl.top_labels = False


#ax.axis("off")
ax.add_feature(cfeature.BORDERS, edgecolor='black', facecolor='None', alpha=0.5)
ax.add_feature(cfeature.LAND,  edgecolor='black', facecolor='None', alpha=0.5)

im = Inf_Fires_Drought_corr.plot.pcolormesh(levels = [-1, -0.75, -0.5, -0.25, -0.1, 0.1, 0.25, 0.5, 0.75, 1], cmap = "RdBu_r", alpha = 0.5, add_colorbar=False, add_labels=False, transform=ccrs.PlateCarree())
im1 = Inf_Fires_Drought_corr_sign.plot.pcolormesh(levels = [-1, -0.75, -0.5, -0.25, -0.1, 0.1, 0.25, 0.5, 0.75, 1], cmap = "RdBu_r", add_colorbar=False,  add_labels=False, transform=ccrs.PlateCarree())

ax_pos = ax.get_position()
cax = fig.add_axes([ax_pos.x0, 0.1, ax_pos.width, 0.03])
cbar = plt.colorbar(im, cax=cax, orientation='horizontal', extend = "neither")
cbar.ax.tick_params(labelsize= 15) 



#Open netCDF files of daily soil mosture
Inf_SM_output = xr.open_dataset("/nfs/a68/lec1stt/Isidora_data/Daily_mean_Met_and_soil_moisture_variables_for_HistSST_INFERNO_UKESM1_2000_2014.nc")['moisture_content_of_soil_layer'][:]

#Open netCDF files of daily soil mosture
Inf_SM_mean = xr.open_dataset("/nfs/a68/lec1stt/Isidora_data/Daily_mean_Met_and_soil_moisture_variables_for_HistSST_INFERNO_UKESM1_2000_2014.nc")

#Read in variables of soil moisture (Volumetric soil water layer), latitude, longitude and time
Inf_SM = Inf_SM_mean['moisture_content_of_soil_layer'][:]
lat = Inf_SM_mean['latitude'][:]
lon = Inf_SM_mean['longitude'][:]
time = Inf_SM_mean['time'][:]


#Selecting all of the soil moisture values of the time frame
Inf_sm = Inf_SM_mean.sel(time = ((Inf_SM_mean.time.dt.day >= 1) & (Inf_SM_mean.time.dt.day <= 5400)))

Inf_sm = Inf_sm.mean(dim = 'bnds')


#Calculating soil moisture across a 30-day moving window mean
Inf_thirtyday_sm = Inf_sm.rolling(time = 30, center = True).mean()

#Calculate the 80th percentile of the soil moisture 9-day moving window 
Inf_Percentile_sm = Inf_thirtyday_sm.quantile(0.8, dim = 'time')

#Calculate where the data soil moisture is less than the 80th Percentile
Inf_sm_function = Inf_SM_mean.where((Inf_sm < Inf_Percentile_sm))

#Fill nan values with 0
Inf_sm1 = Inf_sm_function.fillna(0)

#Replace Soil moisture drought values with 1 
Inf_sm2 = Inf_sm1.where((Inf_sm1 == 0.0), 1)


#Calculate the difference between each successive drought soil moisture value
Inf_diff = Inf_sm2.diff(dim='time', n = 1)

#Where drought event starts the difference is 1 (transition from 0 to 1) 
Inf_drought_starts = Inf_diff.where(Inf_diff == 1)


Inf_drought_starts = Inf_drought_starts.mean("bnds")
Inf_drought_starts = Inf_drought_starts.resample(time = "YS").sum()


Inf_drought_starts["time"] = Inf_drought_starts["time"].astype("datetime64[ns]")
Inf_drought_starts = Inf_drought_starts.to_array()

Inf_drought_starts = Inf_drought_starts.mean(dim = "variable")

Inf_drought_starts = Inf_drought_starts.diff("time")


Yearly_Fires_diff = Yearly_Fires.diff("time")

Inf_Drougths_corr = xr.corr(Inf_drought_starts, Yearly_Fires_diff, dim = "time")


from scipy.stats import t 
res = np.sqrt(15- 2)

Inf_res1 = np.sqrt(1 - (Inf_Drougths_corr**2))

Inf_t_vals =  (res / Inf_res1) * (Inf_Drougths_corr)

Inf_t_vals = Inf_t_vals.fillna(0)
Inf_p_vals = 2 * t.sf(np.abs(Inf_t_vals), df =13)

print(Inf_p_vals.min())


Inf_Droughts_corr_sign = Inf_Drougths_corr.where(Inf_p_vals < 0.05)

# Initiate new Figure 
fig= plt.figure(figsize=(10, 7))

gs = gridspec.GridSpec(1, 1)

index=0

# Initiate new axes 
ax = fig.add_subplot(gs[0], projection=ccrs.PlateCarree())

#Style of axes
crs = ccrs.PlateCarree()

# Add coastlines
ax.coastlines()

#Add gridlines
#gl = ax.gridlines(draw_labels = True, linestyle='--')
#gl.left_labels = False
#gl.bottom_labels = False


# Adjust font sizes
#gl.xlabel_style = {'size': 15}   # Longitude labels
#gl.ylabel_style = {'size': 15}   # Latitude labals

cmap = matplotlib.cm.get_cmap("RdBu_r")
#cmap.set_under(color = "white")

#ax.axis("off")
ax.add_feature(cfeature.BORDERS, edgecolor='black', facecolor='None', alpha=0.5)
ax.add_feature(cfeature.LAND,  edgecolor='black', facecolor='None', alpha=0.5)

IDim = Inf_Drougths_corr.plot.pcolormesh(levels = [-1, -0.75, -0.5, -0.25, -0.1, 0.1, 0.25, 0.5, 0.75, 1], cmap = cmap, add_labels=False, add_colorbar=False, alpha = 0.5, transform=ccrs.PlateCarree())
IDimS = Inf_Droughts_corr_sign.plot.pcolormesh(levels = [-1, -0.75, -0.5, -0.25, -0.1, 0.1, 0.25, 0.5, 0.75, 1], cmap = cmap, add_labels=False, add_colorbar=False, transform=ccrs.PlateCarree())

ax_pos = ax.get_position()
cax = fig.add_axes([ax_pos.x0, 0.1, ax_pos.width, 0.03])
cbar = plt.colorbar(IDim, cax=cax, orientation='horizontal', extend = "neither")



